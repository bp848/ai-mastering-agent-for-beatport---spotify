# 音源アップ → 登録 → 決済 → マイページ 導線の問題一覧

現状のユーザー導線を追い、問題点を整理しました。

## 崩してはいけない設計（マーケティング）

- **ログインなしでプレビューまでたどり着き、音を聴ける** 流れは必須。  
  「まず聴いて、いいじゃん → 気に入ったらログインしてダウンロード」という誘導を増やす設計であり、ここを崩す変更（例: プレビュー前にログイン要求）は行わない。

---

## 想定フロー

| 段階 | 内容 | 現状の実装 |
|------|------|------------|
| 1. 音源アップ | ファイル選択 → 分析 → 診断表示 | ✅ FileUpload / analyzeOnly（ログイン不要） |
| 2. 登録 | ダウンロード時に未ログインならログイン促す | ⚠️ DownloadGateModal → Google OAuth |
| 3. 決済 | 購入（例: 1曲1,000円）→ ダウンロード許可 | ❌ 未実装（UI は「購入」と案内） |
| 4. マイページ | 履歴・購入一覧の確認 | ✅ MyPageView（download_history 表示） |

---

## 問題 1（重大）: ログイン後にマスタリング状態が消える

**現象**

- 未ログインのままマスタリング完了 → 「WAV をダウンロード」クリック → DownloadGateModal → 「Google でログイン」→ OAuth **リダイレクト**で別画面へ飛ぶ。
- リダイレクトから戻ると **ページがフルリロード** するため、`audioBuffer` / `masteringParams` / `audioFile` がすべて失われる。
- 戻った先では「もう一度アップロード → 分析 → マスタリング実行」が必要になり、**登録後の導線がつながらない**。

**影響**

- 「ログインすればこの曲をダウンロード」が成立せず、体験が分断される。

**対応案**

- **A.** OAuth を **ポップアップ** にし、リダイレクトをやめる。ログイン後も同一タブの状態が保たれ、そのままダウンロード可能にする。
- **B.** リダイレクトのまま使う場合、戻ってきたときに「ログインしました。ダウンロードするにはもう一度マスタリングを完了してください」など、状態が消えた理由と次のアクションを明示する。
- **C.** （現実的には難しい）マスタ結果を一時的にサーバーに保存し、ログイン後に「保留中のダウンロード」として再開する。

---

## 問題 2（重大）: 決済が未実装なのに「購入」と案内している

**現象**

- **ResultsModal** の文言:
  - JA: 「再生で確認してから、下のボタンで**購入（1曲1,000円）**してWAVをダウンロード。」
  - EN: "Preview first, then use the button below to **purchase (¥1,000/track)** and download WAV."
- 実際の **handleDownload**（App.tsx）では:
  - ログイン済みならそのまま `applyMasteringAndExport` → ブラウザダウンロード。
  - `recordDownload(session.user.id, audioFile.name, masteringTarget)` を呼ぶだけで、**amount_cents を渡していない**（決済なし）。
- DB には `payments` テーブルと `download_history.amount_cents` が用意されているが、Stripe 等の決済処理は **どこにも実装されていない**。

**影響**

- ユーザーは「1,000円払ってダウンロード」と理解するが、実際は無料でダウンロードできてしまう。
- マイページの「ダウンロード・購入履歴」に金額が一切出ない（`amount_cents` が常に null）。

**対応案**

- **短期:** 「購入（1曲1,000円）」をやめ、「ログイン後にダウンロード」だけ案内する。または「料金は Pricing をご確認ください」などに変更し、決済未実装であることを導線上で曖昧にしない。
- **中期:** Stripe（または他 PG）を導入し、ダウンロード前に PaymentIntent 作成 → 決済完了後に `payments` 挿入＆`recordDownload(..., amountCents)` で履歴に金額を残す（ADMIN_SPEC の想定と一致）。

---

## 問題 3（軽微）: マイページの履歴に金額が出ない

**現象**

- `recordDownload` は `amountCents` を省略可能で、現状 **常に未渡し** のため `download_history.amount_cents` は null。
- MyPageView は `row.amount_cents != null` のときだけ「¥xxx」を表示するため、**現状は一切表示されない**。

**影響**

- 決済を実装すれば `recordDownload(..., 1000)` などで解消される。現時点では決済未実装に伴う一貫した状態。

---

## 問題 4（軽微）: 登録の明示がない

**現象**

- 「登録」は **Google ログイン** と同一扱い（Supabase Auth の初回 signIn が実質的な会員登録）。
- ナビや DownloadGate の文言は「ログイン」が中心で、「初回はアカウント登録」が分かりにくい場合がある。

**対応案**

- ロケールで「ログイン（または登録）」をすでに使っている箇所（例: `auth.download_gate.description`）はそのままでよい。必要なら「アカウント作成」を補足で追加。

---

## チェックリスト（導線の健全性）

| 項目 | 状態 |
|------|------|
| 音源アップロード〜マスタリング完了までログイン不要で完結する | ✅ |
| 未ログインでダウンロード押下時にログインを促す | ✅ |
| ログイン後、**その場で**同じ曲をダウンロードできる | ❌（リダイレクトで状態消失） |
| 決済後にダウンロードできる（または無料の場合はその旨が明確） | ❌（決済未実装・文言は「購入」） |
| マイページでダウンロード履歴が表示される | ✅ |
| マイページで購入金額が表示される | ❌（決済未実装のためデータなし） |

---

## 推奨する修正順序

1. **問題 1（ログイン後の状態消失）**  
   OAuth をポップアップに変更するか、リダイレクト戻り時のメッセージで「もう一度マスタリングしてください」を明示する。
2. **問題 2（決済と文言）**  
   決済を実装するまで、「購入（1曲1,000円）」をやめ、ダウンロードのみ案内する（または「Pricing で料金を確認」に寄せる）。
3. 決済実装時に **recordDownload に amount_cents を渡す** ことで、問題 3（マイページの金額表示）も解消される。

---

*このドキュメントは、音源アップ → 登録 → 決済 → マイページの「導線」に焦点を当てた問題整理です。*
