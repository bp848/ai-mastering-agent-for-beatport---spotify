# 運用管理画面（ADMIN）仕様

## 1. キー管理（漏洩時の更新を運用で対応）

- **設定画面**で以下を入力・保存。ビルド時の環境変数に依存しない。
- **Gemini API Key**: 保存先は Supabase `admin_settings`（または Vault）。マスタリング・SNS提案はサーバー（Edge Function / API）経由で実行し、キーはクライアントに渡さない。
- **Stripe Secret Key / Publishable Key**: 同様に設定画面で保存。決済はサーバー側で PaymentIntent 作成などに使用。
- 漏洩時は設定画面でキーを差し替えて保存するだけでよい（再デプロイ不要）。

## 2. 運用管理画面の構成

| メニュー | 内容 |
|----------|------|
| **設定** | Gemini API Key, Stripe Secret Key, Stripe Publishable Key の入力・保存 |
| **ユーザー一覧** | 登録ユーザー（auth.users ベース）。メール・登録日・最終ログインなど |
| **アップ曲** | ユーザーがアップロードした曲の記録（upload_events または tracks） |
| **DL曲** | ダウンロード履歴（既存 download_history を一覧） |
| **支払い履歴** | Stripe 連携後の決済一覧（payments テーブル） |
| **オリジナルアナリティクス** | GA4 に依存しない自前イベント（ページビュー、アップロード開始、マスタリング完了、ダウンロード、決済完了）の集計・グラフ |
| **広告 費用対効果** | 広告費（手動入力 or 連携）とコンバージョン数・売上との対比 |
| **ファネル検証** | 登録 → アップロード → マスタリング完了 → ダウンロード → 決済 の各段階の転換率 |
| **AI 広告提案** | 上記ファネル・分析結果を入力に、AI が以下を提案: Google 広告の地域、広告文、レスポンシブディスプレイ広告の案。フロントはその結果を表示し、コピーや適用をしやすくする |

## 3. アクセス制御

- **Admin の判定**: Supabase の `admin_emails` テーブルにメールアドレスが存在するユーザーのみが `/admin`（または Admin セクション）にアクセス可能。
- 未許可ユーザーが Admin URL にアクセスした場合は 404 またはリダイレクト。

## 4. データフロー（キー）

```
[設定画面] → 保存 → Supabase admin_settings (または Vault)
[フロント] → マスタリング依頼 → [Edge Function / API] → admin_settings から Gemini Key 取得 → Gemini 呼び出し → 結果をフロントへ返却
[フロント] → 決済開始 → [Edge Function / API] → admin_settings から Stripe Key 取得 → PaymentIntent 作成 → クライアントへ client_secret 返却
```

## 5. オリジナルアナリティクス イベント例

| イベント名 | 発火タイミング |
|------------|----------------|
| `page_view` | トップ表示 |
| `upload_start` | ファイル選択時 |
| `mastering_complete` | マスタリング提案取得完了 |
| `download_click` | ダウンロード実行（ログイン済み） |
| `payment_complete` | Stripe 決済完了 |
| `sign_in` | ログイン完了 |

これらを `analytics_events` に保存し、管理画面で日別・イベント別集計・ファネル計算に利用する。

## 6. AI 広告提案

- 入力: ファネル転換率、主要離脱ポイント、地域別・デバイス別の傾向（分析結果から抽出）、直近の広告費と成果。
- 出力（AI が提案）: 推奨ターゲット地域、広告見出し・説明文の案、レスポンシブディスプレイ用のコピー・画像サイズの提案。
- 実装: 管理画面の「AI 広告提案」セクションで「分析結果を元に提案を生成」ボタン → 上記要約をプロンプトに含めて Gemini 呼び出し（サーバー側、設定の Gemini Key 使用）→ 結果を画面に表示。地域・広告文・ディスプレイ案を項目ごとにコピー可能にする。
